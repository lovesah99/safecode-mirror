%%-----------------------------------------------------------------------------
\section{Run-time Checks and Instrumentation}
\label{section:checks}
%%-----------------------------------------------------------------------------

Below are the run-time checks that SAFECode may add to a program.
Note that many of these functions have alternate versions for pointers
that are determined to be incomplete or unknown by SAFECode's
points-to analysis algorithm.

\begin{itemize}
\item{\tt poolcheck}:
The {\tt poolcheck} call is used to instrument loads and stores to
memory (including LLVM atomic operations).  It ensures that the
pointer points within a memory object in the pool and that the load or
store will not read/write past the end of the memory object.

\item{\tt fastlscheck}:
The {\tt fastlscheck()} function is identical to the {\tt poolcheck()}
function in functionality; the difference is that {\tt fastlscheck()}
is passed the bounds of the memory object into which the pointer
should point.  It is an optimized version of {\tt poolcheck()} that
does not need to search for object bounds information in a side data
structure.

\item{\tt poolcheck\_align}:
The {\tt poolcheck\_align()} function is used when type-safe
load/store optimizations are enabled.  It is possible for a pointer which
is type-safe to be loaded from a memory object which is not type-safe.
When a type-safe pointer is loaded via a type-inconsistent pointer,
{\tt poolcheck\_align()} verifies that the loaded pointer points
within the specified pool at the correctly aligned offset for objects
of its type.  This ensures that no further checks are needed when the
type-safe poiner is used for loads and stores.

\item{\tt poolcheck\_free}:
The {\tt poolcheck\_free()} function checks that the pointer points to
the beginning of a valid heap object.  It is used to catch invalid
{\tt free} calls for allocators not known to tolerate invalid
deallocation requests.

\item{\tt boundscheck}:
The {\tt boundscheck()} function takes a source pointer and a
destination pointer that is computed from the source pointer; the
checks first determines whether the source pointer is within a valid
memory object within the specified pool and, if so, that the
destination pointer is within the same memory object.  It is primarily
used for performing array and structure indexing checks on LLVM {\tt
getelementptr} instructions.

If the destination pointer goes out of bounds, then {\tt
boundscheck()} returns a \emph{rewrite pointer}.  A rewrite pointer
(or \emph{OOB pointer}) point to an unmapped portion of the address
space.  They are used to allow pointers to go out of bounds so long as
they are not dereferenced.

\item{\tt exactcheck}:
The {\tt exactcheck()} function is a fast version of the {\tt
boundscheck()} function that does not need to do an object bounds
lookup.

\item{\tt funccheck}:
The {\tt funccheck()} function determines if a function pointer
belongs to the set of valid function pointer targets for an indirect
function call.  It is used to ensure control-flow integrity.
\end{itemize}

SAFECode also instruments code with other functions to support the
above run-time checks:

\begin{itemize}
\item{\tt getActualValue()}:
The {\tt getActualValue()} function takes a value and determines if it
is a rewrite pointer.  If it is, it returns the actual out-of-bounds
value that the rewrite pointer represents.  Otherwise, it returns the
original value.

The {\tt getActualValue()} function is primarily used for supporting
the comparison of pointers that have gone outside their object bounds.

\item{\tt pool\_register()}:
The {\tt pool\_register()} family of functions register the bounds of
allocated memory objects in side data-structures; these are used to
map a pointer to the memory object to which it belongs in run-time
checks.

Note that some memory objects may not be registered if SAFECode determines
that their bounds are never needed.

\item{\tt pool\_reregister()}:
The {\tt pool\_reregister()} function unregisters a memory object and
registers a new object of the specified size.  It is designed to
support allocators like {\tt realloc()}.
\end{itemize}
