#!/bin/bash -e

expect_error=1

usage()
{
  echo 'usage: test.sh [args] file.c'
  echo 'arguments:'
  echo '   -t dir    directory to use for testing'
  echo '   -p        expect no safecode errors from the test case'
  echo '   -e        expect a safecode error from the test case'
}

# Process the arguments.
while getopts hept: option
  do
    case $option in
      e) expect_error=1;;
      p) expect_error=0;;
      t) testdir=$OPTARG;;
      h) usage
         exit 1;;
      \?) exit 1;;
    esac
  done

# Get the file argument.
shift $((OPTIND-1))

if [ $# -lt 1 ]
then
  usage
  exit 1
fi

llvmgcc=@LLVMGCC@
gxx=@CXX@
sc=@SC@
llc=@LLC@
sc_lib=@SC_LIB@
llvmas=@LLVMAS@

filename=$1
# Directory to use for temporary files.
testdir=${testdir:-$(dirname $filename)}
filebase=$(basename $filename)
case $filebase in
  *.ll) prefix=${filebase%%.ll}
        filetype=ll;;
   *.c) prefix=${filebase%%.c}
        filetype=c;;
     *) echo "unknown file type"
        exit 1;;
esac
# Bitcode object
bcfile=$testdir/${prefix}.bc
# Bitcode with SAFECode transformations
scobj=$testdir/${prefix}.sc.bc
# Compiled version of SAFECode transformations
scasm=$testdir/${prefix}.sc.s
# Final executable
scfile=$testdir/${prefix}.sc
# Executable output
scout=$testdir/${prefix}.output


# Clean up all temporary files the script made.
cleanup()
{
  rm -f $bcfile $scobj $scasm $scfile $scout
  if [ $testdir != '.' ]
  then
    rmdir --ignore-fail-on-non-empty $testdir
  fi
}

# Prepare the testing directory.
setupdir()
{
  # Add temporary directory.
  mkdir -p $testdir
  # Remove previous temporary files, if any.
  rm -f $bcfile $scobj $scasm $scfile $scout
}

# Compile the bitcode of the test.
compile()
{
  # Compile input file to bitcode.
  case $filetype in
     c) $llvmgcc -c -emit-llvm -o $bcfile $filename;;
    ll) $llvmas $filename -o $bcfile;;
  esac
  # Run SAFECode with CStdLib passes on bitcode.
  $sc -terminate -pa=apa -disable-cstdlib=false -o $scobj $bcfile 2>&1
  # Compile native assembly file from processed bitcode.
  $llc -o $scasm $scobj
  # Build and link test.
  $gxx -o $scfile $scasm \
          $sc_lib/libsc_dbg_rt.a \
          $sc_lib/libpoolalloc_bitmap.a \
          $sc_lib/libgdtoa.a
}

# Run test and check results.
runtest()
{
  # Don't exit immediately on failure of below commands.
  set +e
  $scfile >& $scout
  # Ensure the test ran successfully.
  if [ $? -ne 0 ]
  then
    cleanup
    exit 1
  fi
  error_count=$(grep -c SAFECode $scout)
  set -e
  cleanup
  # Exit with a value depending on whether SAFECode output was encountered
  # and if we expected an error.
  if [ $error_count -gt 0 ]
  then
    exit $((!expect_error))
  else
    exit $((expect_error))
  fi
}

setupdir
compile
runtest
